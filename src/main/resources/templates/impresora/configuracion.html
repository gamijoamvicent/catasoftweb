<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Configuración de Impresora - InventSoft</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/configuracionImpresora.css">
    <script src="/js/qz-tray.js"></script>
</head>
<body>
    <div th:replace="~{fragments/header :: header}"></div>
    <div class="main-container">
        <!-- Columna izquierda: Configuración y Estado -->
        <div class="col">
            <div class="card">
                <h2>Impresora Térmica</h2>
                <p class="licoreria-actual">Licorería: <span th:text="${licoreriaActual.nombre}"></span></p>
                <div th:if="${mensaje != null}" class="alert" th:classappend="${clase}"><span th:text="${mensaje}"></span></div>
                <form th:action="@{/impresora/guardar}" method="post" th:object="${configuracion}">
                    <input type="hidden" th:field="*{id}">
                    <div class="form-group">
                        <label for="deteccionAutomatica">Modo de Detección:</label>
                        <div class="radio-group">
                            <label><input type="radio" th:field="*{deteccionAutomatica}" value="true" name="deteccionAutomatica" id="deteccionAutomatica"> Automática</label>
                            <label><input type="radio" th:field="*{deteccionAutomatica}" value="false"> Manual</label>
                        </div>
                    </div>
                    <div class="form-group" id="puertoComContainer" th:style="${configuracion.deteccionAutomatica ? 'display:none' : ''}">
                        <label for="puertoCom">Impresora o Puerto:</label>
                        <select th:field="*{puertoCom}" id="puertoCom">
                            <option value="">Seleccione una impresora o puerto</option>
                        </select>
                        <button type="button" id="btnDetectarPuertos" class="btn-secondary" style="margin-top:8px;">Detectar impresoras y puertos</button>
                    </div>
                    <div class="form-group">
                        <label for="velocidadBaudios">Velocidad (baudios):</label>
                        <select th:field="*{velocidadBaudios}" id="velocidadBaudios">
                            <option value="9600">9600</option>
                            <option value="19200">19200</option>
                            <option value="38400">38400</option>
                            <option value="57600">57600</option>
                            <option value="115200">115200</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bitsDatos">Bits de datos:</label>
                        <select th:field="*{bitsDatos}" id="bitsDatos">
                            <option value="7">7</option>
                            <option value="8">8</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bitsParada">Bits de parada:</label>
                        <select th:field="*{bitsParada}" id="bitsParada">
                            <option value="1">1</option>
                            <option value="2">2</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="paridad">Paridad:</label>
                        <select th:field="*{paridad}" id="paridad">
                            <option value="NONE">Ninguna</option>
                            <option value="EVEN">Par</option>
                            <option value="ODD">Impar</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="anchoPapel">Ancho del papel (mm):</label>
                        <select th:field="*{anchoPapel}" id="anchoPapel">
                            <option value="58">58mm</option>
                            <option value="80">80mm</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dpi">Resolución (DPI):</label>
                        <select th:field="*{dpi}" id="dpi">
                            <option value="203">203 DPI</option>
                            <option value="300">300 DPI</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-container"><input type="checkbox" th:field="*{corteAutomatico}" id="corteAutomatico"> Corte automático del papel</label>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-container"><input type="checkbox" th:field="*{imprimirLogo}" id="imprimirLogo"> Imprimir logo en los tickets</label>
                    </div>
                    <div class="form-group" id="rutaLogoContainer" th:style="${configuracion.imprimirLogo ? '' : 'display:none'}">
                        <label for="rutaLogo">Ruta del logo:</label>
                        <input type="text" th:field="*{rutaLogo}" id="rutaLogo" placeholder="/ruta/al/logo.png">
                    </div>
                    <div class="form-group">
                        <label class="checkbox-container"><input type="checkbox" th:field="*{activa}" id="activa"> Impresora activa</label>
                    </div>
                    <div class="form-group">
                        <label>Impresora configurada actual:</label>
                        <div id="impresoraActual" style="font-weight:bold;color:#1565C0;">
                            <span th:text="${configuracion.deteccionAutomatica} ? '(Automática)' : (configuracion.puertoCom != null ? (configuracion.puertoCom != '' ? configuracion.puertoCom : '(No definida)') : '(No definida)')"></span>
                        </div>
                    </div>
                    <div class="button-group">
                        <button type="submit" class="btn-primary">Guardar Configuración</button>
                    </div>
                </form>
            </div>
        </div>
        <!-- Columna derecha: Editor de Ticket y QZ Tray -->
        <div class="col">
            <div class="card">
                <h3>Editor de Ticket</h3>
                <div class="form-group">
                    <label for="ticketTexto">Contenido del ticket:</label>
                    <textarea id="ticketTexto" name="ticketTexto" rows="7" placeholder="Ingrese el texto del ticket aquí..." th:text="${configuracion.ticketTexto != null && !configuracion.ticketTexto.isEmpty() ? configuracion.ticketTexto : '*** ${licoreria} ***\nFecha: ${fecha}\n----------------------\n${detalle_productos}\n----------------------\nTOTAL: ${total}\n¡Gracias por su compra!'}"></textarea>
                </div>
                <div class="form-group">
                    <label>Previsualización:</label>
                    <div class="ticket-preview" id="ticketPreview"></div>
                </div>
            </div>
            <div class="card">
                <h3>Prueba de Impresión Directa (QZ Tray)</h3>
                <div class="qz-section">
                    <div class="qz-row">
                        <button type="button" id="btnActualizarQz" class="btn-primary" style="flex:0 0 auto;">Actualizar lista</button>
                        <select id="impresoraQz" name="impresoraQz">
                            <option value="">-- Selecciona una impresora --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="textoQz">Texto de prueba:</label>
                        <textarea id="textoQz" rows="3">Prueba de impresión desde InventSoft</textarea>
                    </div>
                    <button type="button" id="btnProbarQz" class="btn-secondary">Probar impresión directa</button>
                    <div id="msgQz" class="alert" style="display:none"></div>
                    <div id="qzStatusQz" class="alert" style="display:none"></div>
                </div>
            </div>
        </div>
    </div>
    <div style="display: flex; justify-content: flex-end; margin: 32px 0 0 0;">
        <a href="/dashboard" class="btn-primary" style="text-decoration:none;">Volver</a>
    </div>
    <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle manual port selection based on detection mode
        const deteccionAutomatica = document.querySelectorAll('input[name="deteccionAutomatica"]');
        const puertoComContainer = document.getElementById('puertoComContainer');
        deteccionAutomatica.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'true') {
                    puertoComContainer.style.display = 'none';
                } else {
                    puertoComContainer.style.display = 'block';
                }
            });
        });
        // Toggle logo path field
        const imprimirLogo = document.getElementById('imprimirLogo');
        const rutaLogoContainer = document.getElementById('rutaLogoContainer');
        imprimirLogo.addEventListener('change', function() {
            rutaLogoContainer.style.display = this.checked ? 'block' : 'none';
        });
        // Detect available ports
        const btnDetectarPuertos = document.getElementById('btnDetectarPuertos');
        const puertoCom = document.getElementById('puertoCom');
        btnDetectarPuertos.addEventListener('click', function() {
            fetch('/impresora/detectar-puertos')
                .then(response => response.json())
                .then(puertos => {
                    puertoCom.innerHTML = '<option value="">Seleccione una impresora o puerto</option>';
                    puertos.forEach(puerto => {
                        const option = document.createElement('option');
                        option.value = puerto;
                        option.textContent = puerto;
                        puertoCom.appendChild(option);
                    });
                })
                .catch(error => {
                    alert('Error al detectar puertos disponibles');
                });
        });
        if (document.querySelector('input[name="deteccionAutomatica"]:checked') &&
            document.querySelector('input[name="deteccionAutomatica"]:checked').value === 'false') {
            btnDetectarPuertos.click();
        }
        // Ticket preview
        const ticketTextarea = document.getElementById('ticketTexto');
        const ticketPreview = document.getElementById('ticketPreview');
        const defaultTicket = `*** {licoreria} ***\nFecha: {fecha}\n----------------------\n{detalle_productos}\n----------------------\nTOTAL: {total}\n¡Gracias por su compra!`;
        function updatePreview() {
            let value = ticketTextarea.value;
            if (!value || value.trim() === '') {
                value = defaultTicket;
            }
            ticketPreview.textContent = value;
        }
        if(ticketTextarea && ticketPreview) {
            ticketTextarea.addEventListener('input', updatePreview);
            updatePreview();
        }
        // QZ Tray integración para impresión directa
        function showMsgQz(text, ok) {
            var msg = document.getElementById('msgQz');
            msg.textContent = text;
            msg.className = 'alert ' + (ok ? 'success' : 'error');
            msg.style.display = 'block';
        }
        function showQzStatusQz(text, ok) {
            var st = document.getElementById('qzStatusQz');
            st.textContent = text;
            st.className = 'alert ' + (ok ? 'success' : 'error');
            st.style.display = 'block';
        }
        function hideQzStatusQz() {
            document.getElementById('qzStatusQz').style.display = 'none';
        }
        function conectarQZQz(callback) {
            if (window.qz && qz.websocket.isActive()) {
                callback && callback();
                return;
            }
            qz.websocket.connect().then(function() {
                showQzStatusQz('QZ Tray conectado', true);
                setTimeout(hideQzStatusQz, 2000);
                callback && callback();
            }).catch(function(err) {
                showQzStatusQz('No se pudo conectar a QZ Tray: ' + err, false);
            });
        }
        function cargarImpresorasQz() {
            conectarQZQz(function() {
                qz.printers.find().then(function(lista) {
                    var sel = document.getElementById('impresoraQz');
                    sel.innerHTML = '<option value="">-- Selecciona una impresora --</option>';
                    lista.forEach(function(i) {
                        var opt = document.createElement('option');
                        opt.value = i; opt.textContent = i;
                        sel.appendChild(opt);
                    });
                }).catch(function(e) {
                    showMsgQz('Error al listar impresoras: ' + e, false);
                });
            });
        }
        document.getElementById('btnActualizarQz').onclick = cargarImpresorasQz;
        document.addEventListener('DOMContentLoaded', cargarImpresorasQz);
        document.getElementById('btnProbarQz').onclick = function() {
            var impresora = document.getElementById('impresoraQz').value;
            var texto = document.getElementById('textoQz').value;
            if (!impresora) {
                showMsgQz('Selecciona una impresora.', false);
                return;
            }
            conectarQZQz(function() {
                qz.printers.find(impresora).then(function(printer) {
                    var config = qz.configs.create(printer);
                    return qz.print(config, [{ type: 'raw', format: 'plain', data: texto + '\n' }]);
                }).then(function() {
                    showMsgQz('Impresión enviada correctamente a "' + impresora + '".', true);
                }).catch(function(e) {
                    showMsgQz('Error al imprimir: ' + e, false);
                });
            });
        };
    });
    </script>
</body>
</html>
